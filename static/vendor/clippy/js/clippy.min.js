!function(t,i){"object"==typeof exports&&"undefined"!=typeof module?module.exports=i(require("jquery")):"function"==typeof define&&define.amd?define(["jquery"],i):t.clippy=i(t.$)}(this,function(t){"use strict";t="default"in t?t.default:t;var i=function t(i){this._queue=[],this._onEmptyCallback=i};i.prototype.queue=function t(i){this._queue.push(i),1!==this._queue.length||this._active||this._progressQueue()},i.prototype._progressQueue=function i(){if(!this._queue.length){this._onEmptyCallback();return}var e=this._queue.shift();this._active=!0,e(t.proxy(this.next,this))},i.prototype.clear=function t(){this._queue=[]},i.prototype.next=function t(){this._active=!1,this._progressQueue()};var e=function i(e,o,n,s){this._el=e,this._data=n,this._path=o,this._currentFrameIndex=0,this._currentFrame=void 0,this._exiting=!1,this._currentAnimation=void 0,this._endCallback=void 0,this._started=!1,this._sounds={},this.currentAnimationName=void 0,this.preloadSounds(s),this._overlays=[this._el];var r=this._el;this._setupElement(this._el);for(var a=1;a<this._data.overlayCount;a++){var h=this._setupElement(t("<div></div>"));r.append(h),this._overlays.push(h),r=h}};e.prototype._setupElement=function t(i){var e=this._data.framesize;return i.css("display","none"),i.css({width:e[0],height:e[1]}),i.css("background","url('"+this._path+"/map.png') no-repeat"),i},e.prototype.animations=function t(){var i=[],e=this._data.animations;for(var o in e)i.push(o);return i},e.prototype.preloadSounds=function t(i){for(var e=this,o=0;o<this._data.sounds.length;o++){var n=e._data.sounds[o],s=i[n];s&&(e._sounds[n]=new Audio(s))}},e.prototype.hasAnimation=function t(i){return!!this._data.animations[i]},e.prototype.exitAnimation=function t(){this._exiting=!0},e.prototype.showAnimation=function t(i,e){return this._exiting=!1,!!this.hasAnimation(i)&&(this._currentAnimation=this._data.animations[i],this.currentAnimationName=i,this._started||(this._step(),this._started=!0),this._currentFrameIndex=0,this._currentFrame=void 0,this._endCallback=e,!0)},e.prototype._draw=function t(){var i=[];this._currentFrame&&(i=this._currentFrame.images||[]);for(var e=0;e<this._overlays.length;e++)if(e<i.length){var o=i[e],n=-o[0]+"px "+-o[1]+"px";this._overlays[e].css({"background-position":n,display:"block"})}else this._overlays[e].css("display","none")},e.prototype._getNextAnimationFrame=function t(){if(this._currentAnimation){if(!this._currentFrame)return 0;var i=this._currentFrame,e=this._currentFrame.branching;if(this._exiting&&void 0!==i.exitBranch)return i.exitBranch;if(e)for(var o=100*Math.random(),n=0;n<e.branches.length;n++){var s=e.branches[n];if(o<=s.weight)return s.frameIndex;o-=s.weight}return this._currentFrameIndex+1}},e.prototype._playSound=function t(){var i=this._currentFrame.sound;if(i){var e=this._sounds[i];e&&e.play()}},e.prototype._atLastFrame=function t(){return this._currentFrameIndex>=this._currentAnimation.frames.length-1},e.prototype._step=function i(){if(this._currentAnimation){var o=Math.min(this._getNextAnimationFrame(),this._currentAnimation.frames.length-1),n=!this._currentFrame||this._currentFrameIndex!==o;this._currentFrameIndex=o,this._atLastFrame()&&this._currentAnimation.useExitBranching||(this._currentFrame=this._currentAnimation.frames[this._currentFrameIndex]),this._draw(),this._playSound(),this._loop=window.setTimeout(t.proxy(this._step,this),this._currentFrame.duration),this._endCallback&&n&&this._atLastFrame()&&(this._currentAnimation.useExitBranching&&!this._exiting?this._endCallback(this.currentAnimationName,e.States.WAITING):this._endCallback(this.currentAnimationName,e.States.EXITED))}},e.prototype.pause=function t(){window.clearTimeout(this._loop)},e.prototype.resume=function t(){this._step()},e.States={WAITING:1,EXITED:0};var o=function t(i){this._targetEl=i,this._hidden=!0,this._setup(),this.WORD_SPEAK_TIME=200,this.CLOSE_BALLOON_DELAY=2e3,this._BALLOON_MARGIN=15};o.prototype._setup=function i(){this._balloon=t('<div class="clippy-balloon"><div class="clippy-tip"></div><div class="clippy-content"></div></div> ').hide(),this._content=this._balloon.find(".clippy-content"),t(document.body).append(this._balloon)},o.prototype.reposition=function t(){for(var i=["top-left","top-right","bottom-left","bottom-right"],e=0;e<i.length;e++){var o=i[e];if(this._position(o),!this._isOut())break}},o.prototype._position=function i(e){var o,n,s=this._targetEl.offset(),r=this._targetEl.height(),a=this._targetEl.width();s.top-=t(window).scrollTop(),s.left-=t(window).scrollLeft();var h=this._balloon.outerHeight(),p=this._balloon.outerWidth();switch(this._balloon.removeClass("clippy-top-left"),this._balloon.removeClass("clippy-top-right"),this._balloon.removeClass("clippy-bottom-right"),this._balloon.removeClass("clippy-bottom-left"),e){case"top-left":o=s.left+a-p,n=s.top-h-this._BALLOON_MARGIN;break;case"top-right":o=s.left,n=s.top-h-this._BALLOON_MARGIN;break;case"bottom-right":o=s.left,n=s.top+r+this._BALLOON_MARGIN;break;case"bottom-left":o=s.left+a-p,n=s.top+r+this._BALLOON_MARGIN}this._balloon.css({top:n,left:o}),this._balloon.addClass("clippy-"+e)},o.prototype._isOut=function i(){var e=this._balloon.offset(),o=this._balloon.outerHeight(),n=this._balloon.outerWidth(),s=t(window).width(),r=t(window).height(),a=t(document).scrollTop(),h=t(document).scrollLeft(),p=e.top-a,u=e.left-h;return p-5<0||u-5<0||p+o+5>r||u+n+5>s},o.prototype.speak=function t(i,e,o){this._hidden=!1,this.show();var n=this._content;n.height("auto"),n.width("auto"),n.text(e),n.height(n.height()),n.width(n.width()),n.text(""),this.reposition(),this._complete=i,this._sayWords(e,o,i)},o.prototype.show=function t(){!this._hidden&&this._balloon.show()},o.prototype.hide=function i(e){if(e){this._balloon.hide();return}this._hiding=window.setTimeout(t.proxy(this._finishHideBalloon,this),this.CLOSE_BALLOON_DELAY)},o.prototype._finishHideBalloon=function t(){!this._active&&(this._balloon.hide(),this._hidden=!0,this._hiding=null)},o.prototype._sayWords=function i(e,o,n){this._active=!0,this._hold=o;var s=e.split(/[^\S-]/),r=this.WORD_SPEAK_TIME,a=this._content,h=1;this._addWord=t.proxy(function(){this._active&&(h>s.length?(delete this._addWord,this._active=!1,this._hold||(n(),this.hide())):(a.text(s.slice(0,h).join(" ")),h++,this._loop=window.setTimeout(t.proxy(this._addWord,this),r)))},this),this._addWord()},o.prototype.close=function t(){this._active?this._hold=!1:this._hold&&this._complete()},o.prototype.pause=function t(){window.clearTimeout(this._loop),this._hiding&&(window.clearTimeout(this._hiding),this._hiding=null)},o.prototype.resume=function i(){this._addWord?this._addWord():this._hold||this._hidden||(this._hiding=window.setTimeout(t.proxy(this._finishHideBalloon,this),this.CLOSE_BALLOON_DELAY))};var n=function n(s,r,a){this.path=s,this._queue=new i(t.proxy(this._onQueueEmpty,this)),this._el=t('<div class="clippy"></div>').hide(),t(document.body).append(this._el),this._animator=new e(this._el,s,r,a),this._balloon=new o(this._el),this._setupEvents()};n.prototype.gestureAt=function t(i,e){var o=this._getDirection(i,e),n="Gesture"+o,s=this.hasAnimation(n)?n:"Look"+o;return this.play(s)},n.prototype.hide=function t(i,e){this._hidden=!0;var o=this._el;if(this.stop(),i){this._el.hide(),this.stop(),this.pause(),e&&e();return}return this._playInternal("Hide",function(){o.hide(),this.pause(),e&&e()})},n.prototype.moveTo=function i(o,n,s){var r="Move"+this._getDirection(o,n);void 0===s&&(s=1e3),this._addToQueue(function(i){if(0===s){this._el.css({top:n,left:o}),this.reposition(),i();return}if(!this.hasAnimation(r)){this._el.animate({top:n,left:o},s,i);return}var a=t.proxy(function(r,a){a===e.States.EXITED&&i(),a===e.States.WAITING&&this._el.animate({top:n,left:o},s,t.proxy(function(){this._animator.exitAnimation()},this))},this);this._playInternal(r,a)},this)},n.prototype._playInternal=function i(e,o){this._isIdleAnimation()&&this._idleDfd&&"pending"===this._idleDfd.state()&&this._idleDfd.done(t.proxy(function(){this._playInternal(e,o)},this)),this._animator.showAnimation(e,o)},n.prototype.play=function i(o,n,s){return!!this.hasAnimation(o)&&(void 0===n&&(n=5e3),this._addToQueue(function(i){var r=!1,a=function(t,o){o===e.States.EXITED&&(r=!0,s&&s(),i())};n&&window.setTimeout(t.proxy(function(){!r&&this._animator.exitAnimation()},this),n),this._playInternal(o,a)},this),!0)},n.prototype.show=function i(e){if(this._hidden=!1,e){this._el.show(),this.resume(),this._onQueueEmpty();return}if("auto"===this._el.css("top")||(this._el.css("left"),0)){var o=.8*t(window).width(),n=(t(window).height()+t(document).scrollTop())*.8;this._el.css({top:n,left:o})}return this.resume(),this.play("Show")},n.prototype.speak=function t(i,e){this._addToQueue(function(t){this._balloon.speak(t,i,e)},this)},n.prototype.closeBalloon=function t(){this._balloon.hide()},n.prototype.delay=function t(i){i=i||250,this._addToQueue(function(t){this._onQueueEmpty(),window.setTimeout(t,i)})},n.prototype.stopCurrent=function t(){this._animator.exitAnimation(),this._balloon.close()},n.prototype.stop=function t(){this._queue.clear(),this._animator.exitAnimation(),this._balloon.hide()},n.prototype.hasAnimation=function t(i){return this._animator.hasAnimation(i)},n.prototype.animations=function t(){return this._animator.animations()},n.prototype.animate=function t(){var i=this.animations(),e=i[Math.floor(Math.random()*i.length)];return 0===e.indexOf("Idle")?this.animate():this.play(e)},n.prototype._getDirection=function t(i,e){var o,n=this._el.offset(),s=this._el.height(),r=this._el.width(),a=n.left+r/2,h=Math.round(180*Math.atan2(n.top+s/2-e,a-i)/Math.PI);return -45<=h&&h<45?"Right":45<=h&&h<135?"Up":135<=h&&h<=180||-180<=h&&h<-135?"Left":-135<=h&&h<-45?"Down":"Top"},n.prototype._onQueueEmpty=function i(){if(!(this._hidden||this._isIdleAnimation())){var e=this._getIdleAnimation();this._idleDfd=t.Deferred(),this._animator.showAnimation(e,t.proxy(this._onIdleComplete,this))}},n.prototype._onIdleComplete=function t(i,o){o===e.States.EXITED&&this._idleDfd.resolve()},n.prototype._isIdleAnimation=function t(){var i=this._animator.currentAnimationName;return i&&0===i.indexOf("Idle")},n.prototype._getIdleAnimation=function t(){for(var i=this.animations(),e=[],o=0;o<i.length;o++){var n=i[o];0===n.indexOf("Idle")&&e.push(n)}return e[Math.floor(Math.random()*e.length)]},n.prototype._setupEvents=function i(){t(window).on("resize",t.proxy(this.reposition,this)),this._el.on("mousedown",t.proxy(this._onMouseDown,this)),this._el.on("dblclick",t.proxy(this._onDoubleClick,this))},n.prototype._onDoubleClick=function t(){this.play("ClickedOn")||this.animate()},n.prototype.reposition=function i(){if(this._el.is(":visible")){var e=this._el.offset(),o=this._el.outerHeight(),n=this._el.outerWidth(),s=t(window).width(),r=t(window).height(),a=t(window).scrollTop(),h=t(window).scrollLeft(),p=e.top-a,u=e.left-h;p-5<0?p=5:p+o+5>r&&(p=r-o-5),u-5<0?u=5:u+n+5>s&&(u=s-n-5),this._el.css({left:u,top:p}),this._balloon.reposition()}},n.prototype._onMouseDown=function t(i){i.preventDefault(),this._startDrag(i)},n.prototype._startDrag=function i(e){this.pause(),this._balloon.hide(!0),this._offset=this._calculateClickOffset(e),this._moveHandle=t.proxy(this._dragMove,this),this._upHandle=t.proxy(this._finishDrag,this),t(window).on("mousemove",this._moveHandle),t(window).on("mouseup",this._upHandle),this._dragUpdateLoop=window.setTimeout(t.proxy(this._updateLocation,this),10)},n.prototype._calculateClickOffset=function t(i){var e=i.pageX,o=i.pageY,n=this._el.offset();return{top:o-n.top,left:e-n.left}},n.prototype._updateLocation=function i(){this._el.css({top:this._targetY,left:this._targetX}),this._dragUpdateLoop=window.setTimeout(t.proxy(this._updateLocation,this),10)},n.prototype._dragMove=function t(i){i.preventDefault();var e=i.clientX-this._offset.left,o=i.clientY-this._offset.top;this._targetX=e,this._targetY=o},n.prototype._finishDrag=function i(){window.clearTimeout(this._dragUpdateLoop),t(window).off("mousemove",this._moveHandle),t(window).off("mouseup",this._upHandle),this._balloon.show(),this.reposition(),this.resume()},n.prototype._addToQueue=function i(e,o){o&&(e=t.proxy(e,o)),this._queue.queue(e)},n.prototype.pause=function t(){this._animator.pause(),this._balloon.pause()},n.prototype.resume=function t(){this._animator.resume(),this._balloon.resume()};var s=function i(e,o,s,r){var a,h,p=(r=r||window.CLIPPY_CDN||"/static/vendor/clippy/agents/")+e,u=i._loadMap(p),l=i._loadAgent(e,p),d=i._loadSounds(e,p);l.done(function(t){a=t}),d.done(function(t){h=t});var c=function(){var t=new n(p,a,h);o(t)};t.when(u,l,d).done(c).fail(s)};s._loadMap=function i(e){var o=s._maps[e];if(o)return o;o=s._maps[e]=t.Deferred();var n=new Image;return n.onload=o.resolve,n.onerror=o.reject,n.setAttribute("src",e+"/map.png"),o.promise()},s._loadSounds=function i(e,o){var n=s._sounds[e];if(n)return n;n=s._sounds[e]=t.Deferred();var r=document.createElement("audio"),a=!!r.canPlayType&&""!==r.canPlayType("audio/mpeg"),h=!!r.canPlayType&&""!==r.canPlayType('audio/ogg; codecs="vorbis"');return a||h?s._loadScript(o+(a?"/sounds-mp3.js":"/sounds-ogg.js")):n.resolve({}),n.promise()},s._loadAgent=function t(i,e){var o=s._data[i];return o||(o=s._getAgentDfd(i),s._loadScript(e+"/agent.js"),o.promise())},s._loadScript=function t(i){var e=document.createElement("script");e.setAttribute("src",i),e.setAttribute("async","async"),e.setAttribute("type","text/javascript"),document.head.appendChild(e)},s._getAgentDfd=function i(e){var o=s._data[e];return o||(o=s._data[e]=t.Deferred()),o},s._maps={},s._sounds={},s._data={};var r={Agent:n,Animator:e,Queue:i,Balloon:o,load:s,ready:function t(i,e){s._getAgentDfd(i).resolve(e)},soundsReady:function i(e,o){var n=s._sounds[e];n||(n=s._sounds[e]=t.Deferred()),n.resolve(o)}};return"undefined"!=typeof window&&(window.clippy=r),r});
